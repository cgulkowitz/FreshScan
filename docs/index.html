<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Receipt → Storage & Expiration Chart</title>
<style>
  :root{
    --bg:#0f0f12; --card:#17181c; --muted:#9aa0a6; --txt:#e8eaed; --accent:#8ab4f8;
    --red:#ff6b6b; --yellow:#ffd166; --green:#06d6a0; --blue:#48cae4;
    --border:#2a2e35;
  }
  *{box-sizing:border-box}
  body{margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; color:var(--txt); background:linear-gradient(180deg,#0b0c10,#101114 40%, #0f1116)}
  header{padding:28px 20px 8px; text-align:center}
  header h1{margin:0 0 6px; font-size:clamp(22px,4vw,32px); letter-spacing:.2px}
  header p{margin:0; color:var(--muted)}
  main{max-width:1100px; margin:18px auto 56px; padding:0 16px}
  .controls, .output, .about{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; margin:14px 0}
  .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
  .row > *{flex:1 1 220px}
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  input[type="file"]{padding:10px; border:1px dashed var(--border); border-radius:10px; background:#101217}
  input[type="date"], input[type="text"], select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#101217; color:var(--txt)}
  .btn{display:inline-flex; gap:8px; align-items:center; padding:10px 14px; border:1px solid var(--border); border-radius:10px; background:#14161b; color:var(--txt); cursor:pointer; text-decoration:none; user-select:none}
  .btn:hover{border-color:#38414a}
  .btn.primary{background:linear-gradient(180deg,#1f2431,#19202b); border-color:#2a3645; color:#e6f0ff}
  .btn.success{background:#113630; border-color:#1b5046}
  .btn.warn{background:#3a2f12; border-color:#5f4a1a}
  .btn.ghost{background:transparent}
  .progress{height:10px; background:#0d1116; border:1px solid var(--border); border-radius:999px; overflow:hidden; margin-top:10px}
  .progress span{display:block; height:100%; width:0%; background:linear-gradient(90deg,#6ea8fe,#65d6ff)}
  table{width:100%; border-collapse:collapse; margin-top:8px; background:#0f1116; border-radius:10px; overflow:hidden}
  th, td{padding:10px 10px; border-bottom:1px solid #1d2229; vertical-align:top}
  th{position:sticky; top:0; background:#12151b; z-index:1; text-align:left; font-weight:600; color:#d7e3ff}
  tbody tr:last-child td{border-bottom:none}
  .pill{display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; letter-spacing:.2px}
  .pill.red{background:color-mix(in oklab, var(--red) 30%, transparent); color:#ffd7d7; border:1px solid color-mix(in oklab, var(--red) 50%, #000 40%)}
  .pill.yellow{background:color-mix(in oklab, var(--yellow) 25%, transparent); color:#fff2cc; border:1px solid color-mix(in oklab, var(--yellow) 45%, #000 40%)}
  .pill.green{background:color-mix(in oklab, var(--green) 22%, transparent); color:#d7fff1; border:1px solid color-mix(in oklab, var(--green) 40%, #000 40%)}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .hint{font-size:12px; color:var(--muted); margin-top:6px}
  .grid{display:grid; grid-template-columns:1fr; gap:14px}
  @media (min-width:900px){ .grid{grid-template-columns: 1.1fr .9fr} }
  .hidden{display:none !important}
  .footer-actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  .small{font-size:12px}
  .kbd{padding:.2rem .45rem; border:1px solid var(--border); border-bottom-width:2px; border-radius:6px; background:#11141a; font:12px ui-monospace,monospace; color:#ddecff}
  .tag{font-size:11px; padding:2px 7px; border-radius:6px; border:1px solid var(--border); color:#cfe1ff}
  .right{float:right}
</style>
</head>
<body>
<header>
  <h1>Receipt → Storage & Expiration Chart</h1>
  <p>Upload a photo of your grocery receipt. I’ll OCR it, detect the date, and build a color-coded chart with storage tips and weekday expiration.</p>
</header>

<main>
  <section class="controls">
    <div class="grid">
      <div>
        <label>Upload receipt image (JPG/PNG)</label>
        <input id="fileInput" type="file" accept="image/*" />
        <div class="hint">Good lighting helps OCR. Crop to the receipt if possible.</div>

        <div id="ocrStatus" class="hint" style="margin-top:8px"></div>
        <div class="progress hidden" id="progress"><span id="bar"></span></div>

        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
          <button class="btn primary" id="runOcrBtn">Run OCR & Build Chart</button>
          <button class="btn ghost" id="sampleBtn" title="Uses the Eataly receipt text from your example">Use sample text</button>
          <button class="btn" id="pasteBtn">Paste text</button>
        </div>
      </div>

      <div>
        <label>Detected/Chosen purchase date</label>
        <input id="purchaseDate" type="date" />
        <div class="hint">If I can’t find the date on the receipt, set it here.</div>

        <label style="margin-top:12px">Shelf life presets (you can edit per item later)</label>
        <select id="presetSelect">
          <option value="default">Default guide</option>
          <option value="conservative">Conservative (earlier)</option>
          <option value="liberal">Liberal (later)</option>
        </select>

        <div class="hint small">Categories include: fish, cooked salads, yogurt, cucumbers, fresh herbs, onions/shallots, chocolate/dessert, and a generic fallback.</div>
      </div>
    </div>
  </section>

  <section class="output">
    <div class="row" style="margin-bottom:8px">
      <div>
        <strong>Parsed items</strong>
        <span class="tag" id="dateBadge"></span>
      </div>
      <div class="right small muted">
        Tip: click any shelf-life to edit; the expiration & color update automatically.
      </div>
    </div>

    <div id="tableWrap" class="hidden">
      <table id="resultTable" aria-label="Expiration table">
        <thead>
          <tr>
            <th style="width:32%">Item</th>
            <th style="width:26%">How to store</th>
            <th style="width:16%">Shelf life</th>
            <th style="width:18%">Expires</th>
            <th style="width:8%">Flag</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div class="footer-actions">
        <button class="btn success" id="downloadCsv">Download CSV</button>
        <button class="btn warn" id="printBtn">Print</button>
        <button class="btn" id="copyBtn">Copy table text</button>
      </div>
    </div>

    <div id="emptyState" class="muted">
      No results yet. Upload a receipt and press <strong>Run OCR</strong>, or click <strong>Use sample text</strong>.
    </div>

    <details style="margin-top:12px">
      <summary class="small">Show raw OCR text</summary>
      <pre id="rawText" class="mono" style="white-space:pre-wrap; background:#0c0f14; border:1px solid #1b212a; border-radius:8px; padding:10px; max-height:240px; overflow:auto"></pre>
    </details>
  </section>

  <section class="about small muted">
    <strong>Notes & assumptions</strong><br>
    • OCR isn’t perfect — I let you edit shelf life / names inline. <br>
    • Expiration rules are estimates. When in doubt, trust the package label or nose test. <br>
    • Color flags: <span class="pill red">≤3 days</span>, <span class="pill yellow">4–10 days</span>, <span class="pill green">>10 days</span>. <br>
  </section>
</main>

<!-- Tesseract.js (client-side OCR) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
/* --------------------- utilities ---------------------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));

function fmtDate(d){
  const dt = new Date(d);
  const y = dt.getFullYear();
  const m = String(dt.getMonth()+1).padStart(2,'0');
  const day = String(dt.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function humanDate(d){
  const dt = new Date(d);
  return dt.toLocaleDateString(undefined,{year:'numeric', month:'short', day:'numeric'}) +
         " (" + dt.toLocaleDateString(undefined,{weekday:'long'}) + ")";
}
function addDays(base, n){
  const d = new Date(base);
  d.setDate(d.getDate() + n);
  return d;
}
function addMonths(base, n){
  const d = new Date(base);
  d.setMonth(d.getMonth() + n);
  return d;
}
function daysBetween(a,b){ return Math.round((b-a)/(1000*60*60*24)); }

/* ------------- shelf-life knowledge base ------------- */
const RULES = {
  default: {
    fish: {days:2, store:"Refrigerate & cook within 1–2 days or freeze"},
    cooked_salad: {days:5, store:"Refrigerate in airtight container"},
    yogurt: {days:10, store:"Refrigerate; keep sealed"},
    cucumber: {days:7, store:"Refrigerate in crisper drawer"},
    herb: {days:7, store:"Wrap in damp paper towel; refrigerate in bag/jar"},
    onion_shallot: {days:30, store:"Cool, dark, ventilated place (not fridge)"},
    chocolate: {days:21, store:"Cool, dry place; refrigerate if warm"},
    generic: {days:7, store:"Refrigerate; check package"}
  },
  conservative: {
    fish: {days:2, store:"Refrigerate & cook within 1 day or freeze"},
    cooked_salad: {days:3, store:"Refrigerate; eat within 3 days"},
    yogurt: {days:7, store:"Refrigerate; keep sealed"},
    cucumber: {days:6, store:"Refrigerate in crisper drawer"},
    herb: {days:5, store:"Wrap damp; refrigerate"},
    onion_shallot: {days:25, store:"Cool, dark, ventilated"},
    chocolate: {days:14, store:"Cool, dry place"},
    generic: {days:5, store:"Refrigerate; check package"}
  },
  liberal: {
    fish: {days:3, store:"Refrigerate or freeze promptly"},
    cooked_salad: {days:6, store:"Refrigerate, airtight"},
    yogurt: {days:12, store:"Refrigerate; keep sealed"},
    cucumber: {days:10, store:"Refrigerate in crisper drawer"},
    herb: {days:8, store:"Wrap damp; refrigerate"},
    onion_shallot: {days:45, store:"Cool, dark, ventilated"},
    chocolate: {days:30, store:"Cool, dry place"},
    generic: {days:9, store:"Refrigerate; check package"}
  }
};

/* keyword → category map (simple heuristics) */
const MAP = [
  {re:/\b(salmon|cod|tuna|halibut|fillet|fish)\b/i, cat:'fish'},
  {re:/\b(farro.*salad|potato.*salad|winter.*salad|deli.*salad)\b/i, cat:'cooked_salad'},
  {re:/\b(yogurt|yoghurt|greek yog|labneh|kefir)\b/i, cat:'yogurt'},
  {re:/\b(cucumber|persian)\b/i, cat:'cucumber'},
  {re:/\b(parsley|cilantro|basil|dill|mint|herb)\b/i, cat:'herb'},
  {re:/\b(shallot|onion)\b/i, cat:'onion_shallot'},
  {re:/\b(chocolate|fondente|fondentenero|dessert|truffle|candy)\b/i, cat:'chocolate'}
];

function categorize(name){
  for (const m of MAP){ if (m.re.test(name)) return m.cat; }
  return 'generic';
}

/* -------------------- OCR handling -------------------- */
const fileInput = $('#fileInput');
const runBtn = $('#runOcrBtn');
const sampleBtn = $('#sampleBtn');
const pasteBtn = $('#pasteBtn');
const progress = $('#progress');
const bar = $('#bar');
const statusEl = $('#ocrStatus');
const tableWrap = $('#tableWrap');
const tbody = $('#tbody');
const emptyState = $('#emptyState');
const rawText = $('#rawText');
const purchaseDate = $('#purchaseDate');
const dateBadge = $('#dateBadge');
const presetSelect = $('#presetSelect');

purchaseDate.value = fmtDate(new Date()); // default today

runBtn.addEventListener('click', async ()=>{
  let image = fileInput.files?.[0];
  if(!image){ alert('Please choose a receipt image first (or click "Use sample text").'); return; }
  await doOCR(image);
});

sampleBtn.addEventListener('click', ()=>{
  const txt = SAMPLE_TEXT.trim();
  handleParsedText(txt);
});

pasteBtn.addEventListener('click', ()=>{
  const txt = prompt("Paste receipt text (or type items, one per line):","");
  if(txt){ handleParsedText(txt); }
});

async function doOCR(file){
  statusEl.textContent = 'Starting OCR…';
  progress.classList.remove('hidden');
  bar.style.width = '0%';

  const worker = await Tesseract.createWorker('eng', 1, {
    logger: m => {
      if(m.status === 'recognizing text'){
        const pct = Math.round(m.progress*100);
        bar.style.width = pct + '%';
        statusEl.textContent = `OCR: ${pct}%`;
      }
    }
  });

  const { data: { text } } = await worker.recognize(file);
  await worker.terminate();

  rawText.textContent = text;
  statusEl.textContent = 'OCR complete.';
  progress.classList.add('hidden');
  handleParsedText(text);
}

/* --------------- parse receipt → items ---------------- */
function handleParsedText(text){
  rawText.textContent = text;

  // Detect purchase date (US style mm/dd/yy or mm/dd/yyyy)
  const dateMatch = text.match(/\b(0?[1-9]|1[0-2])[\/\-](0?[1-9]|[12][0-9]|3[01])[\/\-]([0-9]{2,4})\b/);
  if(dateMatch){
    let [mm, dd, yy] = [dateMatch[1], dateMatch[2], dateMatch[3]];
    if(yy.length===2){ yy = '20' + yy; }
    const detected = new Date(`${yy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}T12:00:00`);
    if(!isNaN(detected)) purchaseDate.value = fmtDate(detected);
  }
  dateBadge.textContent = "Purchase: " + new Date(purchaseDate.value).toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric', year:'numeric'});

  // Split into lines and try to extract "item — price" style rows
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

  // Heuristic: a line with some letters and a trailing price number
  const priceRe = /(\$?\s?\d+(?:\.\d{2})?)$/;
  const likely = lines.filter(l=>{
    if(l.length<3) return false;
    if(/receipt|total|subtotal|tax|change|clerk|store|nyc|visa|debit|credit|sales|card|information/i.test(l)) return false;
    if(/^\d{5,}/.test(l)) return true; // UPC+item line (like your Eataly receipt)
    if(/[A-Za-z]/.test(l) && priceRe.test(l)) return true;
    return false;
  });

  // Build item objects
  const items = [];
  for(const ln of likely){
    // If UPC + name + price (e.g., "852210005159 WHITE MOUSTACHE SUMMER PEACH 8OZ 6.79")
    let name = ln;
    // Remove leading long code(s)
    name = name.replace(/^[\d\s]{6,}\s+/,'');
    // Remove quantity/weight fragments like "0.200 lb @ $3.99/lb 0.80"
    name = name.replace(/\b\d+(?:\.\d+)?\s*(lb|oz|@|\$|pkg|ea|ct|x|lb\.?)\b.*$/i, m=>{
      // keep name before the weight/price cluster if there's an earlier word run
      return '';
    }).trim() || ln.replace(/^\d+\s+/,'');
    // If we removed too much, fallback to original (minus trailing price)
    if(name.length < 3){
      name = ln.replace(priceRe,'').trim();
    }

    // Extract trailing price if present (not used, but handy)
    const pm = ln.match(priceRe);
    const price = pm ? pm[1].replace('$','').trim() : '';

    // sanitize name
    name = name.replace(/\s{2,}/g,' ').replace(/\bEA\b/i,'').trim();
    // Prevent obvious non-item rows
    if(/^\$/.test(name) || /TOTAL|SUBTOTAL|TAX/i.test(name)) continue;

    items.push({raw: ln, name, price});
  }

  // Deduplicate by name (simple)
  const seen = new Set();
  const dedup = items.filter(x=>{
    const key = x.name.toLowerCase();
    if(seen.has(key)) return false;
    seen.add(key); return true;
  });

  buildTable(dedup);
}

/* -------------- build interactive table --------------- */
function shelfLifeFor(name){
  const preset = RULES[presetSelect.value] || RULES.default;
  const cat = categorize(name);
  const rule = preset[cat] || preset.generic;
  return {cat, ...rule};
}

function colorFlag(days){
  if(days <= 3) return {cls:'red', label:'Use ASAP'};
  if(days <= 10) return {cls:'yellow', label:'Use Soon'};
  return {cls:'green', label:'Lasts a while'};
}

function buildTable(items){
  tbody.innerHTML = '';
  const base = new Date(purchaseDate.value);

  if(!items.length){
    tableWrap.classList.add('hidden');
    emptyState.classList.remove('hidden');
    return;
  }

  for(const it of items){
    const rule = shelfLifeFor(it.name);
    const tr = document.createElement('tr');

    // Compute expiry
    let expires;
    if(rule.months){ expires = addMonths(base, rule.months); }
    else { expires = addDays(base, rule.days); }

    const days = daysBetween(base, expires);
    const flag = colorFlag(days);

    tr.innerHTML = `
      <td><div style="font-weight:600">${escapeHtml(titleCase(it.name))}</div>
          <div class="muted mono small">${escapeHtml(it.raw)}</div></td>
      <td>${escapeHtml(rule.store)}</td>
      <td>
        <input class="lifeInput" type="text" value="${rule.days ?? (rule.months*30)} days" 
               style="width:120px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:#0f1217; color:var(--txt)">
        <div class="hint small">edit (e.g. “5 days” or “2 months”)</div>
      </td>
      <td class="expiresCell"><strong>${escapeHtml(humanDate(expires))}</strong></td>
      <td class="flagCell"><span class="pill ${flag.cls}">${flag.label}</span></td>
    `;
    tbody.appendChild(tr);
  }

  tableWrap.classList.remove('hidden');
  emptyState.classList.add('hidden');
  dateBadge.textContent = "Purchase: " + new Date(purchaseDate.value).toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric', year:'numeric'});

  // attach editors
  $$('#resultTable .lifeInput').forEach((inp, idx)=>{
    inp.addEventListener('change', ()=>{
      const val = inp.value.trim().toLowerCase();
      let nDays = 7;
      const m = val.match(/(\d+(?:\.\d+)?)\s*(day|days|d|month|months|mo)/);
      if(m){
        const num = parseFloat(m[1]);
        const unit = m[2];
        nDays = /mo|month/.test(unit) ? Math.round(num*30) : Math.round(num);
      }
      const base = new Date(purchaseDate.value);
      const newExp = addDays(base, nDays);

      const row = inp.closest('tr');
      row.querySelector('.expiresCell').innerHTML = `<strong>${escapeHtml(humanDate(newExp))}</strong>`;
      const flag = colorFlag(nDays);
      const flagCell = row.querySelector('.flagCell');
      flagCell.innerHTML = `<span class="pill ${flag.cls}">${flag.label}</span>`;
    });
  });
}

/* --------------------- actions ------------------------ */
$('#downloadCsv').addEventListener('click', ()=>{
  const rows = [['Item','How to store','Shelf life','Expires','Flag']];
  $$('#resultTable tbody tr').forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    rows.push([
      tds[0].firstElementChild.textContent.trim(),
      tds[1].textContent.trim(),
      tds[2].querySelector('input').value.trim(),
      tds[3].textContent.trim(),
      tds[4].textContent.trim()
    ]);
  });
  const csv = rows.map(r=>r.map(s=>`"${s.replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = Object.assign(document.createElement('a'), {href:url, download:`receipt-expirations-${fmtDate(new Date())}.csv`});
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});
$('#printBtn').addEventListener('click', ()=> window.print());
$('#copyBtn').addEventListener('click', ()=>{
  const lines = [];
  $$('#resultTable tbody tr').forEach(tr=>{
    const [item, store, life, exp, flag] = tr.querySelectorAll('td');
    lines.push(`${item.firstElementChild.textContent} — ${store.textContent} — ${life.querySelector('input').value} — ${exp.textContent} — ${flag.textContent}`);
  });
  navigator.clipboard.writeText(lines.join('\n'));
  alert('Table copied to clipboard.');
});
purchaseDate.addEventListener('change', ()=>{
  // recompute expirations for all rows
  $$('#resultTable tbody tr').forEach(tr=>{
    const inp = tr.querySelector('.lifeInput');
    inp.dispatchEvent(new Event('change'));
  });
  dateBadge.textContent = "Purchase: " + new Date(purchaseDate.value).toLocaleDateString(undefined,{weekday:'long', month:'short', day:'numeric', year:'numeric'});
});

/* ---------------- sample (your Eataly) ---------------- */
const SAMPLE_TEXT = `
EATALY
200 5th Ave. New York City, NY 10010
10/28/25 5:45 PM
Clerk: Cyrus Kisitu
852210005159 WHITE MOUSTACHE SUMMER PEACH 8OZ 6.79
852210005012 WHITE MOUSTACHE GREEK YOG 8 OZ 6.79
34047 ORGANIC SALMON FILLET 0.15
0.005 lb @ $29.99/lb
2063012 FARRO WINTER SALAD 14.99NYT
8006380230039 MINI FONDENTENERO 16 13.99NYT
05783690001 CUCUMBER PERSIAN ORGANIC 12X1LB 4.99
10634 ONION SHALLOT 0.200 lb @ $3.99/lb 0.80
10397 HERB PARSLEY ITALIAN FRESH 1.99
SUBTOTAL 50.49
NYC SALES TAX 8.875% 2.57
TOTAL 53.06
`;

/* ------------------- helpers -------------------------- */
function titleCase(s){ return s.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()); }
function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>
